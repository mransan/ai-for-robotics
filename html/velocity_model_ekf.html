<!DOCTYPE html>
<meta charset="utf-8"> 
<style>

.bar { 
  fill: steelblue;
}
.bearing {
  stroke:red; 
  stroke-width:1;
}

.axis text {
  font: 10px sans-serif;
}

.axis path, .axis line {
  fill: none;
  stroke: #000; 
  shape-rendering: crispEdges;
}

</style> 

<svg class="chart">
</svg> 
<script src="d3.min.js" charset="utf-8">
</script> 
<script src="distribution.js" charset="utf-8">
</script> 
<script>

  var svg = d3.select(".chart"); 

  var width  = 500; 
  var height = 500; 
  svg.attr("width", width).attr("height", height);
  var ell     = svg.append("ellipse").attr("class", "bar");
  var bearing = svg.append("line").attr("class", "bearing");

  var limit = 8; 
  var x = d3.scale.linear().range([0, width ]).domain([-limit*0.75, limit*.75]);
  var y = d3.scale.linear().range([height, 0]).domain([-limit/2, limit]);

  var y_axis = d3.svg.axis().scale(y).orient("left");
  svg.append("g")
      .attr("class", "y axis")
      .attr("transform", "translate(" + x(0) + ", 0)")
      .call(y_axis);

  var x_axis   = d3.svg.axis().scale(x).orient("bottom"); 
  svg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + y(0) + ")")
    .call(x_axis);

  function do_display(data) {
      var dx       = data[0];
      var dy       = data[1];
      var dbearing = data[2];
      var dtheta   = data[3];
      var drx      = data[4];
      var dry      = data[5];

      var cx = x(dx); 
      var cy = y(dy);

      ell
        .attr("cx", cx)
        .attr("cy", cy)
        .attr("transform", "rotate(" + (-dtheta) + ", " + cx + "," + cy + ")")
        .attr("rx", 20 * drx)
        .attr("ry", 20 * dry);

      var x2 = x(dx + 0.5 * Math.cos(dbearing));
      var y2 = y(dy + 0.5 * Math.sin(dbearing));

      bearing 
        .attr("x1", cx)
        .attr("y1", cy)
        .attr("x2", x2)
        .attr("y2", y2);
  }

  d3.json("velocity_model_ekf.json", function (error, all_data) {
    var i = 0;
    (function display() {
      var data = all_data[i];  
      do_display(data);
      i = i+1; 
      if(i !== all_data.length) {
        setTimeout(display,10); 
      }
    })(); 
  });

</script>
